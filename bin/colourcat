from __future__ import print_function

import sys
import argparse
import errno
import functools

# set default separator
print = functools.partial(print, sep='')

try:
    import magic
    magic = magic.Magic(mime_encoding=True)
    def is_binary(blob):
        return (magic.from_buffer(blob) == 'binary')

except ImportError:
    def is_binary(blob):
        return False

import pygments
from pygments import lexers, formatters, console

# default formatter and lexer
default_formatter = formatters.TerminalFormatter()
#default_lexer = lexers.TextLexer()

# styles
filename_style = console.codes['yellow'] + console.codes['underline']
number_style = console.codes['standout'] #italics
error_style = console.codes['red']
binary_style = console.codes['brown']
reset_style = console.codes['reset']

filename_format = '{}==> {{}} <=={}'.format(filename_style, reset_style)

class BinaryFileException(Exception):
    def __init__(self, text):
        self.text = text


def try_lexer(function, *args, **kwargs):
    try:
        return function(*args, **kwargs)
    except pygments.util.ClassNotFound:
        return None

def highlight_file(filename, **kwargs):
    with open(filename, 'rb') as f:
        text = f.read()

    lexer = try_lexer(lexers.get_lexer_for_filename, filename)
    lexer = lexer or try_lexer(lexers.guess_lexer, text[:1024])

    return highlight(text, lexer, default_formatter, **kwargs)

def highlight_text(text, **kwargs):
    lexer = try_lexer(lexers.guess_lexer, text[:1024])
    return highlight(text, lexer, default_formatter, **kwargs)

def highlight_stdin(**kwargs):
    return highlight_text(sys.stdin.read(), **kwargs)

def highlight(text, lexer, formatter, **kwargs):
    if is_binary(text):
        raise BinaryFileException(text)
    return pygments.highlight(text, lexer, formatter)


def main(files, **kwargs):
    if not files:
        files.append('-')

    multiple = len(files) > 1
    for filename in files:
        if filename == '-':
            printed_filename = 'standard input'
        else:
            printed_filename = filename

        if multiple:
            print(filename_format.format(printed_filename))

        try:
            if filename == '-':
                highlighted = highlight_stdin(**kwargs)
            else:
                highlighted = highlight_file(filename, **kwargs)
        except (IOError, OSError) as e:
            print(error_style, e, reset_style)
            continue
        except BinaryFileException as e:
            print(binary_style, '[Binary file]', reset_style)
            continue

        try:
            if args.number_lines:
                highlighted = highlighted.splitlines()
                columns = max(len(str(len(highlighted))), 6)
                number_format = '{}{{:>{}}}{}'.format(number_style, columns, reset_style)
                for lineno, line in enumerate(highlighted, 1):
                    print(number_format.format(lineno), '\t', line)

            else:
                print(highlighted)
        except IOError as e:
            if e.errno == errno.EPIPE:
                break
            raise

parser = argparse.ArgumentParser(description="Coloured cat")
parser.add_argument('-n', action='store_true', help='number lines of output', dest='number_lines')
parser.add_argument('files', nargs='*')

args = parser.parse_args()
try:
    main(**vars(args))
except KeyboardInterrupt:
    pass

